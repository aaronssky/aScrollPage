/*! testGrunt 2014-12-23 */
function ScrollPage(a){this.ele=a,this.ele.style.height=document.documentElement.clientHeight+"px",addEventHandler(document,isPC()?"mousedown":"touchstart",function(a){a.preventDefault()});var b=document.createElement("div").style;vendor=function(){for(var a,c=["webkitT","MozT","msT","OT","t"],d=0,e=c.length;e>d;d++)if(a=c[d]+"ransform",a in b)return c[d].substr(0,c[d].length-1);return!1}()}function setTranCss(){var a="translate3d(0px,",b=",0)";0==arguments.length?this.style[vendor+"Transform"]=a+0+"px"+b:1==arguments.length?this.style[vendor+"Transform"]=a+arguments[0]+"px"+b:2==arguments.length?(this.style[vendor+"Transform"]=a+arguments[0]+"px"+b,this.style[vendor+"Transition"]=arguments[1]):3==arguments.length&&(this.style[vendor+"Transform"]=a+arguments[0]+"px"+b+" scale("+arguments[2]+")",this.style[vendor+"Transition"]=arguments[1]),this.style[vendor+"TransitionTimingFunction"]="ease-in-out"}function addClass(a,b){for(var c=a.getAttribute("class"),d=c.split(" "),e=0;e<d.length;e++)if(d[e]==b)return!1;a.setAttribute("class",d.join(" ")+" "+b)}function removeClass(a,b){for(var c=a.getAttribute("class"),d=c.split(" "),e=[],f=0;f<d.length;f++)d[f]!=b&&e.push(d[f]);a.setAttribute("class",e.join(" "))}function addEventHandler(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent?a.attachEvent("on"+b,c):a["on"+b]=c}function removeEventHandler(a,b,c){a.removeEventListener?a.removeEventListener(b,c,!1):a.detachEvent?a.detachEvent("on"+b,c):delete a["on"+b]}function isPC(){for(var a=navigator.userAgent,b=new Array("Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"),c=!0,d=0;d<b.length;d++)if(a.indexOf(b[d])>0){c=!1;break}return c}ScrollPage.prototype={init:function(a){this.initData(a?a:{}),this.bindEvent()},initData:function(a){this.pages=this.ele.querySelectorAll(".page"),this.docEleH=document.documentElement.clientHeight,this.pageNow=1,this.usingScale=!0,this.isPc=isPC(),this.isMoving=!1,this.moved=!1,this.moving=!1,this.fn_afterSliding=[],this.fn_touchSliding=[],this.fn_startSlideToPage=[],this.scrollSuccess=!1,this.duration=500,this.scale=.8,this.threshold=100,this.setData(a)},setData:function(a){function b(b,c,d){return b in a&&a[b][c]&&"function"==typeof a[b][c]?a[b][c]:d}for(var c=0;c<this.pages.length;c++)this.fn_touchSliding.push(function(a){return b("fn_touchSliding",a,function(){console.log("手指触摸滑动当前页开始,准备切换到 "+a+" 页")})}(c)),this.fn_startSlideToPage.push(function(a){return b("fn_startSlideToPage",a,function(){console.log("自动切换至下一页 : "+a)})}(c)),this.fn_afterSliding.push(function(a){return b("fn_afterSliding",a,function(){console.log("滑动完成:"+a)})}(c));"duration"in a?this.duration=a.duration:"","usingScale"in a?this.usingScale=!!a.usingScale:"","scale"in a&&parseFloat(a.scale)>0&&parseFloat(a.scale)<1?this.scale=parseFloat(a.scale):"","threshold"in a?this.threshold=a.threshold:""},bindEvent:function(){function a(a){d.mousedown.call(d,a,c)}function b(a){d.mouseup.call(d,a,c)}function c(a){d.mousemove.call(d,a)}var d=this;addEventHandler(this.ele,this.isPc?"mousedown":"touchstart",a),addEventHandler(this.ele,this.isPc?"mouseup":"touchend",b)},mousedown:function(a,b){if(this.moved)return!1;this.setTransition(""),this.setPagesIndex(),this.originClientY=this.isPc?a.clientY:a.targetTouches[0].clientY;addEventHandler(this.ele,this.isPc?"mousemove":"touchmove",b)},mouseup:function(a,b){if(!this.moved)return removeEventHandler(this.ele,this.isPc?"mousemove":"touchmove",b),!1;if(this.moving)return!1;var c=this,d=this.docEleH,e="all "+this.duration/1e3+"s";this.moving=!0,this.setTransition(e);var f=this.pages[this.pageNow-1].style[vendor+"Transform"].split("px, ");clearTimeout(this.timer);var g=1/(1-this.scale);f&&Math.abs(f[1])>this.threshold/(this.usingScale?g:1)?("next"==this.direction?(this.usingScale?setTranCss.call(this.pages[this.pageNow-1],-d/g,e,this.scale):setTranCss.call(this.pages[this.pageNow-1],-d,e),setTranCss.call(this.pages[this.pageNow],0),c.pageNow++):(this.usingScale?setTranCss.call(this.pages[this.pageNow-1],d/g,e,this.scale):setTranCss.call(this.pages[this.pageNow-1],d,e),setTranCss.call(this.pages[this.pageNow-2],0),c.pageNow--),this.scrollSuccess=!0,this.fn_startSlideToPage[this.pageNow-1]()):("next"==this.direction&&this.pageNow<this.pages.length?(setTranCss.call(this.pages[this.pageNow-1],0),setTranCss.call(this.pages[this.pageNow],d)):this.pageNow>1&&(setTranCss.call(this.pages[this.pageNow-1],0),setTranCss.call(this.pages[this.pageNow-2],-d)),this.scrollSuccess=!1),this.timer=setTimeout(function(){c.revertPages(),c.isMoving=!1,c.moved=!1,c.moving=!1,c.scrollSuccess?c.fn_afterSliding[c.pageNow-1]():"",this.timer=0,c.direction=""},this.duration),removeEventHandler(this.ele,this.isPc?"mousemove":"touchmove",b)},mousemove:function(a){if(this.moving)return!1;a.preventDefault(),this.isPc?"":a.clientY=a.targetTouches[0].clientY;var b=this.docEleH;this.originClientY<a.clientY&&this.pageNow>1?("prev"!=this.direction?this.fn_touchSliding[this.pageNow-2]():"",this.moved=!0,this.direction="prev",this.usingScale?setTranCss.call(this.pages[this.pageNow-1],(a.clientY-this.originClientY)*(1-this.scale),"",1-(1-this.scale)*(a.clientY-this.originClientY)/b):setTranCss.call(this.pages[this.pageNow-1],a.clientY-this.originClientY),addClass(this.pages[this.pageNow-2],"active"),setTranCss.call(this.pages[this.pageNow-2],-b-(this.originClientY-a.clientY)),this.pageNow<this.pages.length?removeClass(this.pages[this.pageNow],"active"):""):this.originClientY>a.clientY&&this.pageNow<this.pages.length?("next"!=this.direction?this.fn_touchSliding[this.pageNow]():"",this.moved=!0,this.direction="next",this.usingScale?setTranCss.call(this.pages[this.pageNow-1],(a.clientY-this.originClientY)*(1-this.scale),"",1+(1-this.scale)*(a.clientY-this.originClientY)/b):setTranCss.call(this.pages[this.pageNow-1],a.clientY-this.originClientY),addClass(this.pages[this.pageNow],"active"),setTranCss.call(this.pages[this.pageNow],b-(this.originClientY-a.clientY)),this.pageNow>1?removeClass(this.pages[this.pageNow-2],"active"):""):(this.direction="",1==this.pageNow?(removeClass(this.pages[1],"active"),setTranCss.call(this.pages[0],0)):this.pageNow==this.pages.length&&(setTranCss.call(this.pages[this.pages.length-1],0),removeClass(this.pages[this.pages.length-2],"active")))},revertPages:function(){for(var a=0;a<this.pages.length;a++)this.pages[a].style[vendor+"Transform"]="",this.pages[a].style[vendor+"Transition"]="",this.pages[a].style.zIndex="",a+1!=this.pageNow&&removeClass(this.pages[a],"active")},setTransition:function(a){for(var b=0;b<this.pages.length;b++)this.pages[b].style[vendor+"Transition"]=a},setPagesIndex:function(){this.pageNow>1&&this.pageNow<this.pages.length?(this.pages[this.pageNow-1].style.zIndex=0,this.pages[this.pageNow-2].style.zIndex=1):this.pageNow==this.pages.length&&(this.pages[this.pageNow-1].style.zIndex=0,this.pages[this.pageNow-2].style.zIndex=1)}};